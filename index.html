<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Inteligente de Água Mineral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Tailwind sky-100 */
        }
        .tab-button.active {
            border-color: #0284c7; /* Tailwind sky-600 */
            color: #0284c7;
            font-weight: 600;
            background-color: #f0f9ff; /* Tailwind sky-50 */
        }
        .tab-button {
            transition: all 0.3s ease-in-out;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-overflow-scrolling: touch;
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 24px;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            width: 90%;
            max-width: 600px;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind shadow-xl */
        }
        .close-button {
            color: #9ca3af; /* Tailwind gray-400 */
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #1f2937; /* Tailwind gray-800 */
            text-decoration: none;
            cursor: pointer;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f9ff; /* Tailwind sky-50 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #7dd3fc; /* Tailwind sky-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #38bdf8; /* Tailwind sky-400 */
        }
        .card {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #0ea5e9; /* Tailwind sky-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0284c7; /* Tailwind sky-600 */
        }
        .btn-secondary {
            background-color: #10b981; /* Tailwind emerald-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Tailwind emerald-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* Tailwind red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Tailwind red-600 */
        }
        .btn-warning {
            background-color: #f59e0b; /* Tailwind amber-500 */
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706; /* Tailwind amber-600 */
        }
        .btn-sm {
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            font-size: 0.875rem; /* text-sm */
        }
        .form-input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); /* shadow-sm */
            outline: none;
        }
        .form-input:focus {
            border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25); /* ring-sky-500 */
        }
        .icon {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            margin-right: 0.5rem; /* mr-2 */
        }
        .status-gray { background-color: #d1d5db; color: #4b5563; } 
        .status-green { background-color: #d1fae5; color: #065f46; } 
        .status-yellow { background-color: #fef3c7; color: #b45309; } 
        .status-red { background-color: #fee2e2; color: #991b1b; } 
        .status-blue { background-color: #bae6fd; color: #075985; }


        #simple-whatsapp-container {
            position: sticky;
            top: 20px; 
            z-index: 10;
        }
        @media (max-width: 768px) { 
            #simple-whatsapp-container {
                position: relative; 
                top: auto;
                margin-top: 1rem;
            }
        }
        #detailed-sales-report-table th, #detailed-sales-report-table td {
            padding: 0.75rem; 
            text-align: left;
            font-size: 0.875rem; 
        }
        #detailed-sales-report-table th {
            background-color: #f9fafb; 
            font-weight: 500; 
            color: #374151; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        #detailed-sales-report-table tbody tr:nth-child(even) {
            background-color: #f0f9ff; 
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .sort-asc::after {
            content: ' ▲';
            font-size: 0.7em;
        }
        .sort-desc::after {
            content: ' ▼';
            font-size: 0.7em;
        }
    </style>
</head>
<body class="p-2 md:p-6">
    <div class="container mx-auto max-w-7xl bg-white shadow-xl rounded-lg p-4 md:p-6">
        <header class="mb-6 md:mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Gestão Inteligente de Água Mineral</h1>
            <p class="text-gray-600 mt-1">Otimizando seu atendimento e controle de pedidos.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-1 md:space-x-4 overflow-x-auto pb-1" aria-label="Tabs">
                <button onclick="app.changeTab('clientes')" class="tab-button active whitespace-nowrap py-3 px-3 md:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-sky-700 hover:border-sky-300 rounded-t-md">
                    Clientes e Pedidos
                </button>
                <button onclick="app.changeTab('todos_clientes')" class="tab-button whitespace-nowrap py-3 px-3 md:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-sky-700 hover:border-sky-300 rounded-t-md">
                    Todos os Clientes
                </button>
                <button onclick="app.changeTab('importar')" class="tab-button whitespace-nowrap py-3 px-3 md:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-sky-700 hover:border-sky-300 rounded-t-md">
                    Importar Clientes
                </button>
                <button onclick="app.changeTab('inativos')" class="tab-button whitespace-nowrap py-3 px-3 md:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-sky-700 hover:border-sky-300 rounded-t-md">
                    Painel de Inativos
                </button>
                <button onclick="app.changeTab('relatorios')" class="tab-button whitespace-nowrap py-3 px-3 md:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-sky-700 hover:border-sky-300 rounded-t-md">
                    Relatórios
                </button>
            </nav>
        </div>

        <main id="app-content">
            <section id="clientes-tab" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-sky-700 mb-4">Buscar Cliente</h2>
                        <label for="search-phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (busca automática):</label>
                        <div class="flex space-x-2 items-center">
                            <input type="tel" id="search-phone" class="form-input flex-grow" placeholder="(XX) XXXXX-XXXX">
                            <button onclick="app.openLocatorModal()" class="btn btn-primary">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                                Localizador
                            </button>
                        </div>
                        <div id="new-client-button-container" class="mt-4 hidden">
                             <button onclick="app.showNewClientFormFromButton()" class="btn btn-warning w-full">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg>
                                Cadastrar Novo Cliente
                            </button>
                        </div>
                    </div>

                    <div id="client-and-order-section" class="hidden space-y-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold text-sky-700 mb-3">Dados do Cliente</h3>
                            <p><strong>Nome:</strong> <span id="client-name-display" class="text-gray-800"></span></p>
                            <p><strong>Endereço:</strong> <span id="client-address-display" class="text-gray-800"></span></p>
                            <p><strong>Telefone:</strong> <span id="client-phone-display" class="text-gray-800"></span></p>
                            <input type="hidden" id="current-client-id">

                            <div id="last-orders-summary" class="mt-4 pt-3 border-t border-gray-200">
                                <h4 class="text-md font-semibold text-gray-600 mb-2">Últimos Pedidos:</h4>
                                <div id="last-orders-list" class="text-sm text-gray-700 space-y-1">
                                    <p class="text-gray-500">Nenhum pedido anterior registrado.</p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-semibold text-sky-700 mb-3">Novo Pedido</h3>
                            <div id="order-items-container" class="space-y-3">
                                </div>
                            <button onclick="app.addOrderItem()" class="btn btn-secondary mt-3 text-sm">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                Adicionar Item
                            </button>
                            
                            <div class="mt-4">
                                <label for="payment-method" class="block text-sm font-medium text-gray-700">Forma de Pagamento:</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <select id="payment-method" class="form-input flex-grow" onchange="app.generateSimpleWhatsAppMessage()">
                                        <option value="">Selecione...</option>
                                        <option value="Pix">Pix</option>
                                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                                        <option value="Cartão de Débito">Cartão de Débito</option>
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Pago Antecipadamente">Pago Antecipadamente</option>
                                    </select>
                                    <button onclick="app.setOrderAsPaid()" class="btn btn-sm bg-teal-500 hover:bg-teal-600 text-white whitespace-nowrap px-3 py-2">
                                        JÁ ESTÁ PAGO
                                    </button>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-t border-gray-200">
                                <p class="text-lg font-semibold text-gray-800">Total do Pedido: R$ <span id="order-total" class="text-emerald-600">0.00</span></p>
                            </div>

                            <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <button onclick="app.finalizeOrder()" class="btn btn-primary flex-grow">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                                    Finalizar Pedido
                                </button>
                                <button onclick="app.generateWhatsAppMessage(false)" class="btn btn-secondary flex-grow">
                                     <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                    Gerar Mensagem Completa
                                </button>
                            </div>
                            <textarea id="whatsapp-message-complete" rows="5" class="form-input hidden mt-3" readonly placeholder="Mensagem completa para WhatsApp..."></textarea>
                        </div>
                    </div>

                    <div id="new-client-form-section" class="card hidden">
                        <h3 class="text-xl font-semibold text-amber-700 mb-3">Cadastrar Novo Cliente</h3>
                        <div>
                            <label for="new-client-name" class="block text-sm font-medium text-gray-700">Nome:</label>
                            <input type="text" id="new-client-name" class="form-input">
                        </div>
                        <div class="mt-3">
                            <label for="new-client-address" class="block text-sm font-medium text-gray-700">Endereço:</label>
                            <input type="text" id="new-client-address" class="form-input">
                        </div>
                        <div class="mt-3">
                            <label for="new-client-phone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                            <input type="tel" id="new-client-phone" class="form-input" placeholder="(XX) XXXXX-XXXX">
                        </div>
                        <button onclick="app.saveNewClientAndProceedToOrder()" class="btn btn-warning mt-4 w-full">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Salvar e Continuar Pedido
                        </button>
                    </div>
                </div>

                <div class="md:col-span-1">
                    <div id="simple-whatsapp-container" class="card hidden">
                        <h3 class="text-lg font-semibold text-sky-700 mb-2">Mensagem Rápida (WhatsApp)</h3>
                        <textarea id="whatsapp-message-simple" rows="5" class="form-input" readonly placeholder="Detalhes para cópia rápida..."></textarea>
                        <button onclick="app.copySimpleWhatsAppMessage()" class="btn btn-primary mt-2 w-full text-sm">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.625v2.625m0 0H19.5m-2.25-2.625h-1.5m1.5 0l-1.5-1.5m1.5 1.5l1.5 1.5" /></svg>
                            Copiar Mensagem Rápida
                        </button>
                    </div>
                </div>
            </section>

            <section id="todos_clientes-tab" class="hidden card">
                <h2 class="text-xl font-semibold text-sky-700 mb-4">Todos os Clientes Cadastrados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Cadastro</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endereço</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                </tr>
                        </thead>
                        <tbody id="all-clients-list" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="importar-tab" class="hidden card">
                <h2 class="text-xl font-semibold text-sky-700 mb-4">Importar Clientes via Excel</h2>
                <p class="text-sm text-gray-600 mb-1">Selecione um arquivo Excel (.xlsx ou .xls).</p>
                <p class="text-xs text-gray-500 mb-3">Colunas esperadas: <strong>Name</strong> (Nome + Endereço) e <strong>Mobile Phone</strong> (Telefone).</p>
                <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                <button onclick="app.importClientsFromExcel()" class="btn btn-primary mt-4">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.338 0 4.5 4.5 0 01-1.41 8.775H6.75z" /></svg>
                    Importar Arquivo
                </button>
                <div id="import-status" class="mt-3 text-sm text-gray-700"></div>
            </section>

            <section id="inativos-tab" class="hidden card">
                <h2 class="text-xl font-semibold text-sky-700 mb-4">Painel de Clientes Inativos</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="app.sortInactiveClients('name')">Nome</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="app.sortInactiveClients('lastOrderDate')">Último Pedido</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" onclick="app.sortInactiveClients('daysInactive')">Dias Sem Comprar</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="inactive-clients-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="relatorios-tab" class="hidden card">
                <h2 class="text-xl font-semibold text-sky-700 mb-4">Relatório Mensal de Vendas</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                    <label for="report-month" class="text-sm font-medium text-gray-700">Mês/Ano:</label>
                    <input type="month" id="report-month" class="form-input sm:w-auto" value="">
                    <button onclick="app.generateSalesReport()" class="btn btn-primary">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 19.875v-6.75zM3 8.625c0-.621.504-1.125 1.125-1.125h15.75c.621 0 1.125.504 1.125 1.125v0c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 8.625v0zM3.75 7.5A2.25 2.25 0 016 5.25h12A2.25 2.25 0 0120.25 7.5v0A2.25 2.25 0 0118 9.75H6A2.25 2.25 0 013.75 7.5v0z" /></svg>
                        Gerar Relatório
                    </button>
                </div>
                <div id="sales-report-summary" class="mb-4 p-3 border border-gray-200 rounded bg-sky-50">
                     <p class="text-gray-500">Selecione o mês e clique em "Gerar Relatório".</p>
                </div>
                <div class="mb-4">
                    <canvas id="sales-chart" height="150"></canvas>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-700 my-4">Detalhes dos Pedidos</h3>
                <div class="overflow-x-auto mb-4">
                    <table id="detailed-sales-report-table" class="min-w-full divide-y divide-gray-200 shadow rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Pedido</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marca</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-sales-report-tbody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">Nenhum dado detalhado para exibir. Gere o relatório.</td></tr>
                        </tbody>
                    </table>
                </div>

                <button onclick="app.exportSalesReportToExcel()" id="export-excel-button" class="btn btn-secondary hidden">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Exportar para Excel
                </button>
            </section>
        </main>

        <div id="notification-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="app.closeModal('notification-modal')">&times;</span>
                <p id="notification-message" class="text-gray-700"></p>
            </div>
        </div>

        <div id="locator-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="app.closeModal('locator-modal')">&times;</span>
                <h3 class="text-xl font-semibold text-sky-700 mb-4">Localizador de Clientes</h3>
                <input type="text" id="locator-search-term" class="form-input mb-3" placeholder="Buscar por nome, endereço ou telefone...">
                <button onclick="app.searchClientsUniversal()" class="btn btn-primary w-full mb-4">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    Buscar
                </button>
                <div id="locator-results" class="max-h-60 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50">
                    <p class="text-gray-500">Nenhum resultado.</p>
                </div>
            </div>
        </div>

        <div id="inactive-client-observation-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="app.closeModal('inactive-client-observation-modal')">&times;</span>
                <h3 class="text-xl font-semibold text-sky-700 mb-4">Observações do Cliente Inativo</h3>
                <input type="hidden" id="inactive-client-id-obs">
                <div class="mb-3">
                    <p><strong>Nome:</strong> <span id="inactive-client-name-obs" class="text-gray-700"></span></p>
                    <p><strong>Endereço:</strong> <span id="inactive-client-address-obs" class="text-gray-700"></span></p>
                    <p><strong>Telefone:</strong> <span id="inactive-client-phone-obs" class="text-gray-700"></span></p>
                </div>
                <div class="mb-4">
                    <label for="inactive-client-observation-text" class="block text-sm font-medium text-gray-700">Motivo da inatividade / Observações:</label>
                    <textarea id="inactive-client-observation-text" rows="4" class="form-input mt-1"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="app.closeModal('inactive-client-observation-modal')" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800">Cancelar</button>
                    <button onclick="app.saveInactiveClientObservation()" class="btn btn-primary">Salvar Observações</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Carregado. Iniciando script principal...");

            const SUPABASE_URL = 'https://mnplhyjktwbubjnhtfdy.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ucGxoeWprdHdidWJqbmh0ZmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MzA2OTQsImV4cCI6MjA2MzAwNjY5NH0.Uij6rK7344-w9ECgvi2ICtz--zWBtGF5wUwlckSY17w'; 
            
            let supabaseInstance = null;

            if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                try {
                    supabaseInstance = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } catch (e) {
                    console.error("Erro ao inicializar o cliente Supabase:", e);
                    alert("Erro crítico ao inicializar conexão com a base de dados.");
                    return; 
                }
            } else {
                console.error("ERRO CRÍTICO: Biblioteca Supabase não definida.");
                alert("Erro crítico: Falha ao carregar componentes essenciais.");
                return; 
            }

            window.app = {
                db: supabaseInstance, 
                clients: [], 
                products: [
                    { name: "Biovida", price: 17.00 }, { name: "Aqua Vita", price: 17.00 }, { name: "Purin", price: 17.00 },
                    { name: "Premier", price: 22.00 }, { name: "Serra dos Órgãos", price: 22.00 },
                    { name: "Lindoya Joia", price: 25.00 }
                ],
                currentOrder: [], 
                currentClient: null,
                salesChartInstance: null,
                detailedOrdersData: [],
                inactiveSortKey: 'daysInactive', 
                inactiveSortDir: 'desc',      


                async init() { 
                    if (!this.db) {
                        this.showNotification("Falha crítica na inicialização da base de dados.", 0);
                        return;
                    }
                    await this.loadClients(); 
                    this.changeTab('clientes');
                    this.setDefaultReportMonth();
                    this.setupEventListeners();
                    this.applyPhoneMask(document.getElementById('search-phone'));
                    this.applyPhoneMask(document.getElementById('new-client-phone'));
                },

                setupEventListeners() {
                    const searchPhoneInput = document.getElementById('search-phone');
                    if (searchPhoneInput) {
                        searchPhoneInput.addEventListener('input', (e) => {
                            this.applyPhoneMask(e.target);
                            const unmaskedPhone = e.target.value.replace(/\D/g, '');
                            if (unmaskedPhone.length === 10 || unmaskedPhone.length === 11) {
                                this.searchClientByPhone(false); 
                            } else if (unmaskedPhone.length === 0) {
                                this.clearClientAndOrderDetails();
                                document.getElementById('new-client-button-container').classList.add('hidden');
                            }
                        });
                    }
                    const newClientPhoneInput = document.getElementById('new-client-phone');
                     if (newClientPhoneInput) {
                        newClientPhoneInput.addEventListener('input', (e) => this.applyPhoneMask(e.target));
                    }
                    window.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape') {
                            this.closeModal('notification-modal');
                            this.closeModal('locator-modal');
                            this.closeModal('inactive-client-observation-modal'); 
                        }
                    });
                },
                
                applyPhoneMask(inputElement) {
                    if (!inputElement) return;
                    let value = inputElement.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    let maskedValue = '';
                    if (value.length > 0) maskedValue = '(' + value.substring(0, 2);
                    if (value.length > 2) maskedValue += ') ' + value.substring(2, value.length <= 6 ? value.length : (value.length === 11 ? 7 : 6) );
                    if (value.length > (value.length === 11 ? 7 : 6)) maskedValue += '-' + value.substring((value.length === 11 ? 7 : 6));
                    inputElement.value = maskedValue;
                },

                showNotification(message, duration = 3000) {
                    const modal = document.getElementById('notification-modal');
                    const messageElement = document.getElementById('notification-message');
                    if (modal && messageElement) {
                        messageElement.textContent = message;
                        modal.style.display = "block";
                        if (duration > 0) {
                            setTimeout(() => this.closeModal('notification-modal'), duration);
                        }
                    } else {
                        alert(message); 
                    }
                },

                closeModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.style.display = "none";
                },

                changeTab(tabName) {
                    ['clientes-tab', 'todos_clientes-tab', 'importar-tab', 'inativos-tab', 'relatorios-tab'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    const currentTabEl = document.getElementById(`${tabName}-tab`);
                    if (currentTabEl) currentTabEl.classList.remove('hidden');
                    const currentButtonEl = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
                    if (currentButtonEl) currentButtonEl.classList.add('active');

                    if (tabName === 'inativos') this.updateInactiveClientsPanel();
                    if (tabName === 'relatorios') this.generateSalesReport();
                    if (tabName === 'todos_clientes') this.displayAllClients(); 
                },

                async loadClients() {
                    if (!this.db) {
                        this.showNotification("Erro: cliente Supabase não definido.", 0);
                        return;
                    }
                    const PAGE_SIZE = 1000; 
                    let from = 0;
                    let allClientsData = [];
                    this.showNotification("Carregando clientes da nuvem...", 0);
                    try {
                        let hasMore = true;
                        while(hasMore) {
                            const { data, error } = await this.db
                                .from("clientes")
                                .select( 
                                    `id, name, address, phone, createdAt, lastOrderDate, observacoes_inativo, 
                                     pedidos:pedidos_client_id_fkey(id, date, items, total, paymentMethod)`
                                )
                                .range(from, from + PAGE_SIZE - 1)
                                .order("createdAt", { ascending: false });
                            if (error) {
                                this.showNotification(`Falha ao ler clientes: ${error.message}`, 0); return;
                            }
                            if (data) allClientsData.push(...data);
                            if (!data || data.length < PAGE_SIZE) hasMore = false; 
                            else from += PAGE_SIZE;
                        }
                        this.clients = allClientsData.map(client => ({
                            ...client,
                            orders: (client.pedidos || []).sort((a, b) => new Date(b.date) - new Date(a.date))
                        }));
                        this.closeModal('notification-modal'); 
                        this.showNotification(`Clientes carregados! Total: ${this.clients.length}`, 3000);
                    } catch (error) {
                        this.showNotification(`Exceção ao carregar clientes: ${error.message}`, 0);
                    }
                    this.updateInactiveClientsPanel();
                    this.displayAllClients();
                },

                extractNameAndAddress(nameField) {
                    if (!nameField || typeof nameField !== 'string') return { name: '', address: '' };
                    nameField = nameField.trim(); let name = nameField; let address = '';
                    const hyphenSeparatorIndex = nameField.indexOf(" - ");
                    if (hyphenSeparatorIndex !== -1) {
                        name = nameField.substring(0, hyphenSeparatorIndex).trim();
                        address = nameField.substring(hyphenSeparatorIndex + 3).trim();
                        if (name && address) return { name, address };
                    }
                    const addressKeywords = ['rua', 'av', 'av.', 'avenida', 'travessa', 'trv', 'alameda', 'estrada', 'rodovia', 'praça', 'largo', 'condominio', 'cond.', 'bloco', 'bl.', 'apto', 'apartamento', 'casa', 'cs', 'km', 'nº', 'numero', 'cep', 'sala', 'sl', 'lj', 'loja'];
                    const parts = nameField.split(/\s+/); let nameEndIndex = parts.length; 
                    for (let i = 1; i < parts.length; i++) {
                        const currentWord = parts[i].toLowerCase().replace(/[.,]/g, ''); 
                        const prevWord = parts[i-1];
                        if ( ( (/^\d+$/.test(parts[i]) || addressKeywords.includes(currentWord)) && i > 1 ) || (prevWord && prevWord.endsWith(',')) ) {
                            let potentialNameEnd = i; if (parts[i-1] && parts[i-1].endsWith(',')) potentialNameEnd = i-1; 
                            if (potentialNameEnd >= 1 && potentialNameEnd <= 4) { nameEndIndex = potentialNameEnd; break; }
                        }
                    }
                    name = parts.slice(0, nameEndIndex).join(' ').trim(); address = parts.slice(nameEndIndex).join(' ').trim();
                    if (!address && parts.length > 3) {
                        let splitPoint = (parts.length > 4 && parts[2].length > 2) ? 3 : 2;
                        name = parts.slice(0, splitPoint).join(' '); address = parts.slice(splitPoint).join(' ');
                    }
                    return { name: name || nameField, address: address || 'Endereço não especificado' };
                },

                async importClientsFromExcel() {
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    const fileInput = document.getElementById('excel-file-input');
                    const importStatus = document.getElementById('import-status');
                    if (!fileInput || !importStatus || !fileInput.files.length) {
                        this.showNotification(fileInput && fileInput.files.length === 0 ? "Selecione um arquivo Excel." : "Erro interno.", 0);
                        return;
                    }
                    this.showNotification("Importando clientes...", 0); importStatus.textContent = "Lendo arquivo...";
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                            let clientsFromExcel = []; const nowISO = new Date().toISOString();
                            for (const sheetName of workbook.SheetNames) {
                                const ws = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                                if (jsonData.length < 2) continue;
                                const header = jsonData[0].map(h => String(h).trim().toLowerCase());
                                const nameIdx = header.indexOf("name"); const phoneIdx = header.indexOf("mobile phone");
                                if (nameIdx === -1 || phoneIdx === -1) { importStatus.textContent = `Erro: Cabeçalhos não encontrados na planilha ${sheetName}.`; continue; }
                                for (let i = 1; i < jsonData.length; i++) {
                                    const row = jsonData[i];
                                    const nameField = row[nameIdx] ? String(row[nameIdx]).trim() : '';
                                    const phone = row[phoneIdx] ? String(row[phoneIdx]).replace(/\D/g, '') : '';
                                    if (nameField && phone) {
                                        const { name, address } = this.extractNameAndAddress(nameField);
                                        clientsFromExcel.push({ name, address, phone, createdAt: nowISO, observacoes_inativo: null }); 
                                    }
                                }
                            }
                            if (clientsFromExcel.length === 0) {
                                importStatus.textContent = "Nenhum cliente válido encontrado."; this.showNotification("Nenhum cliente válido.", 3000);
                                if (fileInput) fileInput.value = ''; this.closeModal('notification-modal'); return;
                            }
                            const uniqueClientsMap = new Map();
                            clientsFromExcel.forEach(client => { if (!uniqueClientsMap.has(client.phone)) uniqueClientsMap.set(client.phone, client); });
                            const clientsToUpsert = Array.from(uniqueClientsMap.values());
                            importStatus.textContent = `Processando ${clientsToUpsert.length} clientes...`;
                            const BATCH_SIZE_UPSERT = 100; let errorsDuringUpsert = 0;
                            for (let i = 0; i < clientsToUpsert.length; i += BATCH_SIZE_UPSERT) {
                                const batch = clientsToUpsert.slice(i, i + BATCH_SIZE_UPSERT);
                                if (batch.length > 0) {
                                    const { error } = await this.db.from('clientes').upsert(batch, { onConflict: 'phone' });
                                    if (error) { console.error(`Erro no upsert:`, error); errorsDuringUpsert += batch.length; }
                                }
                            }
                            importStatus.textContent = "Atualizando lista..."; await this.loadClients();
                            this.showNotification(`${clientsToUpsert.length - errorsDuringUpsert} clientes processados. ${errorsDuringUpsert} falharam.`, 7000);
                            if (fileInput) fileInput.value = '';
                        } catch (e) {
                            this.showNotification(`Erro ao importar: ${e.message}.`, 0); importStatus.textContent = `Erro: ${e.message}.`;
                        } finally { this.closeModal('notification-modal'); }
                    };
                    reader.readAsArrayBuffer(fileInput.files[0]);
                },
                
                clearClientAndOrderDetails() {
                    document.getElementById('client-name-display').textContent = '';
                    document.getElementById('client-address-display').textContent = '';
                    document.getElementById('client-phone-display').textContent = '';
                    document.getElementById('current-client-id').value = '';
                    document.getElementById('client-and-order-section').classList.add('hidden');
                    document.getElementById('new-client-form-section').classList.add('hidden');
                    document.getElementById('simple-whatsapp-container').classList.add('hidden');
                    document.getElementById('last-orders-list').innerHTML = '<p class="text-gray-500">Nenhum pedido anterior.</p>';
                    document.getElementById('payment-method').value = ''; 
                    this.currentClient = null; this.currentOrder = []; this.renderOrderItems();
                },

                async searchClientByPhone(showNotFoundNotification = true) { 
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    const phone = document.getElementById('search-phone').value.replace(/\D/g, '');
                    const newClientBtnContainer = document.getElementById('new-client-button-container');
                    if (!phone && showNotFoundNotification) return this.showNotification("Digite um telefone.");
                    this.showNotification("Buscando cliente...", 0);
                    try { 
                        const { data: foundClient, error } = await this.db
                            .from('clientes')
                            .select(`*, observacoes_inativo, pedidos:pedidos_client_id_fkey(id, date, items, total, paymentMethod)`)
                            .eq('phone', phone)
                            .maybeSingle(); 
                        if (error) throw error;
                        this.closeModal('notification-modal'); 
                        if (foundClient) {
                            foundClient.orders = (foundClient.pedidos || []).sort((a, b) => new Date(b.date) - new Date(a.date));
                            delete foundClient.pedidos; 
                            this.displayClientDetails(foundClient); 
                            newClientBtnContainer.classList.add('hidden');
                            document.getElementById('new-client-form-section').classList.add('hidden');
                        } else {
                            this.clearClientAndOrderDetails(); 
                            if (phone.length >= 10) { 
                                 newClientBtnContainer.classList.remove('hidden');
                                 if (showNotFoundNotification) this.showNotification("Cliente não encontrado.");
                            } else {
                                newClientBtnContainer.classList.add('hidden');
                            }
                        }
                    } catch (error) {
                        this.showNotification(`Erro ao buscar: ${error.message}`); this.closeModal('notification-modal');
                    }
                },

                displayClientDetails(client) { 
                    this.currentClient = client; 
                    document.getElementById('client-name-display').textContent = client.name;
                    document.getElementById('client-address-display').textContent = client.address;
                    document.getElementById('client-phone-display').textContent = this.formatPhone(client.phone);
                    document.getElementById('current-client-id').value = client.id;
                    document.getElementById('search-phone').value = this.formatPhone(client.phone); 
                    document.getElementById('client-and-order-section').classList.remove('hidden');
                    document.getElementById('simple-whatsapp-container').classList.remove('hidden');
                    document.getElementById('new-client-form-section').classList.add('hidden');
                    document.getElementById('new-client-button-container').classList.add('hidden');
                    this.resetOrderForm(); this.updateLastOrdersSummary(); this.generateSimpleWhatsAppMessage(); 
                },
                
                showNewClientFormFromButton() {
                    const phoneFromSearch = document.getElementById('search-phone').value;
                    document.getElementById('new-client-phone').value = phoneFromSearch; 
                    this.applyPhoneMask(document.getElementById('new-client-phone'));
                    document.getElementById('new-client-name').value = '';
                    document.getElementById('new-client-address').value = '';
                    document.getElementById('new-client-form-section').classList.remove('hidden');
                    document.getElementById('new-client-button-container').classList.add('hidden');
                    document.getElementById('client-and-order-section').classList.add('hidden'); 
                },

                async saveNewClientAndProceedToOrder() {
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    const name = document.getElementById('new-client-name').value.trim();
                    const address = document.getElementById('new-client-address').value.trim();
                    const phone = document.getElementById('new-client-phone').value.replace(/\D/g, '');
                    if (!name || !phone || (phone.length < 10)) return this.showNotification("Nome e Telefone são obrigatórios.");
                    this.showNotification("Salvando cliente...", 0);
                    try {
                         const { data: existingClient, error: fetchError } = await this.db.from('clientes').select('id').eq('phone', phone).maybeSingle();
                        if (fetchError) throw fetchError;
                        if (existingClient) { this.closeModal('notification-modal'); return this.showNotification("Telefone já cadastrado."); }
                        const newClientData = { name, address, phone, createdAt: new Date().toISOString(), observacoes_inativo: null };
                        const { data: insertedClientArray, error: insertError } = await this.db.from('clientes').insert([newClientData]).select(); 
                        if (insertError) throw insertError;
                        if (!insertedClientArray || insertedClientArray.length === 0) throw new Error("Falha ao obter dados do cliente.");
                        const newClientWithId = { ...insertedClientArray[0], orders: [] }; 
                        this.clients.push(newClientWithId); 
                        this.showNotification(`Cliente ${name} cadastrado!`);
                        this.displayClientDetails(newClientWithId); 
                        this.updateInactiveClientsPanel(); this.displayAllClients(); 
                    } catch (error) {
                        this.showNotification(`Erro ao salvar: ${error.message}`); this.closeModal('notification-modal');
                    }
                },

                formatPhone(phone) {
                    if (!phone) return '';
                    const cleaned = String(phone).replace(/\D/g, '');
                    if (cleaned.length === 11) return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    if (cleaned.length === 10) return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    return phone;
                },

                resetOrderForm() {
                    this.currentOrder = []; this.renderOrderItems(); this.updateOrderTotal();
                    document.getElementById('payment-method').value = ''; 
                    const whatsappMsgCompleteEl = document.getElementById('whatsapp-message-complete');
                    whatsappMsgCompleteEl.classList.add('hidden'); whatsappMsgCompleteEl.value = '';
                    this.generateSimpleWhatsAppMessage();
                },

                addOrderItem() {
                    this.currentOrder.push({ brand: "", quantity: 1, price: 0 });
                    this.renderOrderItems(); this.generateSimpleWhatsAppMessage();
                },

                removeOrderItem(index) {
                    this.currentOrder.splice(index, 1);
                    this.renderOrderItems(); this.updateOrderTotal();
                },
                
                renderOrderItems() {
                    const container = document.getElementById('order-items-container'); if (!container) return;
                    container.innerHTML = '';
                    if (this.currentOrder.length === 0 && this.currentClient) this.currentOrder.push({ brand: "", quantity: 1, price: 0 });
                    this.currentOrder.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex space-x-2 items-center p-2 border rounded-md bg-gray-50';
                        itemDiv.innerHTML = `
                            <select onchange="app.updateOrderItem(${index}, this.value, null)" class="form-input flex-grow">
                                <option value="">Selecione Marca</option>
                                ${this.products.map(p => `<option value="${p.name}" ${item.brand === p.name ? 'selected' : ''}>${p.name} - R$ ${p.price.toFixed(2)}</option>`).join('')}
                            </select>
                            <input type="number" min="1" value="${item.quantity}" onchange="app.updateOrderItem(${index}, null, parseInt(this.value))" class="form-input w-20 text-center" placeholder="Qtd">
                            <button onclick="app.removeOrderItem(${index})" class="btn btn-danger btn-sm p-1.5">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" /></svg>
                            </button>`;
                        container.appendChild(itemDiv);
                    });
                    this.updateOrderTotal(); 
                },

                updateOrderItem(index, brand, quantity) {
                    if (brand !== null) {
                        const product = this.products.find(p => p.name === brand);
                        this.currentOrder[index].brand = brand;
                        this.currentOrder[index].price = product ? product.price : 0;
                    }
                    if (quantity !== null) this.currentOrder[index].quantity = Math.max(1, quantity);
                    this.updateOrderTotal();
                },

                updateOrderTotal() {
                    const total = this.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    document.getElementById('order-total').textContent = total.toFixed(2);
                    this.generateSimpleWhatsAppMessage(); 
                },

                setOrderAsPaid() {
                    const paymentMethodSelect = document.getElementById('payment-method');
                    if (paymentMethodSelect) {
                        paymentMethodSelect.value = 'Pago Antecipadamente';
                        const event = new Event('change', { bubbles: true });
                        paymentMethodSelect.dispatchEvent(event); 
                        this.showNotification("Forma de pagamento: 'Pago Antecipadamente'.", 2000);
                    }
                },

                async finalizeOrder() {
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    if (!this.currentClient) return this.showNotification("Nenhum cliente selecionado.");
                    const validItems = this.currentOrder.filter(item => item.brand && item.quantity > 0);
                    if (validItems.length === 0) return this.showNotification("Adicione itens ao pedido.");
                    const paymentMethod = document.getElementById('payment-method').value;
                    if (!paymentMethod) return this.showNotification("Selecione a forma de pagamento.");
                    this.showNotification("Finalizando pedido...", 0);
                    try {
                        const orderDataToSave = {
                            client_id: this.currentClient.id, date: new Date().toISOString().split('T')[0],
                            items: validItems.map(item => ({ brand: item.brand, quantity: item.quantity, price: item.price })), 
                            total: parseFloat(document.getElementById('order-total').textContent), paymentMethod: paymentMethod 
                        };
                        const { data: insertedOrderArray, error: orderError } = await this.db.from('pedidos').insert([orderDataToSave]).select();
                        if (orderError) throw orderError;
                        if (!insertedOrderArray || insertedOrderArray.length === 0) throw new Error("Falha ao obter dados do pedido.");
                        const insertedOrder = insertedOrderArray[0];
                        const { error: clientUpdateError } = await this.db.from('clientes').update({ lastOrderDate: orderDataToSave.date }).eq('id', this.currentClient.id);
                        if (clientUpdateError) throw clientUpdateError;
                        this.currentClient.lastOrderDate = orderDataToSave.date;
                        if (!this.currentClient.orders) this.currentClient.orders = [];
                        this.currentClient.orders.unshift(insertedOrder); 
                        const clientIndex = this.clients.findIndex(c => c.id === this.currentClient.id);
                        if (clientIndex !== -1) this.clients[clientIndex] = { ...this.currentClient }; 
                        this.showNotification("Pedido finalizado e salvo!");
                        this.updateInactiveClientsPanel(); this.updateLastOrdersSummary(); this.generateWhatsAppMessage(true); 
                    } catch (error) {
                        this.showNotification(`Erro ao finalizar: ${error.message}`); this.closeModal('notification-modal');
                    }
                },
                
                // Modificado para retornar "Sr" ou "Sra" sem ponto.
                getSalutation(name) {
                    if (!name || typeof name !== 'string' || name.trim() === '') return "Prezado(a)";
                    const firstName = name.split(' ')[0].toLowerCase();
                    const feminineNames = ['ana', 'maria', 'julia', 'laura', 'sofia', 'helena', 'manuela', 'isabela', 'alice', 'beatriz', 'clara', 'eloa', 'giulia', 'isadora', 'livia', 'lorena', 'luiza', 'mariana', 'melissa', 'valentina', 'yasmin', 'bianca']; // Adicionado Bianca para exemplo
                    // Considera nomes femininos comuns ou que terminam com 'a' (com algumas exceções se necessário)
                    if (feminineNames.some(n => firstName.includes(n)) || (firstName.length > 1 && firstName.endsWith('a') && firstName !== 'joa' /* Adicionar outras exceções masculinas terminadas em 'a' aqui se necessário */)) {
                        return "Sra"; 
                    }
                    return "Sr"; 
                },

                // Modificado para incluir saudação e ajustar separadores
                generateSimpleWhatsAppMessage() {
                    const el = document.getElementById('whatsapp-message-simple'); if (!el) return;
                    if (!this.currentClient) { el.value = ''; return; }

                    const salutation = this.getSalutation(this.currentClient.name);
                    let clientInfo = `${salutation} ${this.currentClient.name}`; // Saudação + Nome

                    if (this.currentClient.address && this.currentClient.address !== 'Endereço não especificado') {
                        clientInfo += ` - ${this.currentClient.address}`; // Separador " - " para endereço
                    }
                    clientInfo += ` – ${this.formatPhone(this.currentClient.phone)}`; // Separador " – " para telefone (mantido)

                    const validItems = this.currentOrder.filter(item => item.brand && item.quantity > 0);
                    let orderInfo = "";
                    if (validItems.length > 0) {
                        const itemsSummary = validItems.map(item => `${item.quantity}x ${item.brand}`).join(', ');
                        const orderTotal = validItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        let paymentMethod = document.getElementById('payment-method').value;
                        
                        let paymentMethodText = paymentMethod;
                        if (paymentMethod === "Pago Antecipadamente") {
                            paymentMethodText = "Pago Antecipadamente"; 
                        }
                        
                        orderInfo = `${itemsSummary} – R$ ${orderTotal.toFixed(2)}`;
                        if (paymentMethod) orderInfo += ` – ${paymentMethodText}`;

                    } else orderInfo = "(Nenhum item selecionado)";
                    el.value = `${clientInfo}\n${orderInfo}`;
                },

                copySimpleWhatsAppMessage() {
                    const textarea = document.getElementById('whatsapp-message-simple');
                    if (!textarea) {
                        this.showNotification("Erro: Elemento da mensagem não encontrado.", 0);
                        return;
                    }
                    const text = textarea.value;
                    if (!text) {
                        this.showNotification("Nada para copiar.", 2000);
                        return;
                    }
                
                    textarea.focus(); 
                    textarea.select();
                    textarea.setSelectionRange(0, 99999); 
                
                    if (!navigator.clipboard) {
                        this.showNotification("Falha ao copiar: API de Clipboard não suportada.", 0);
                        console.warn("Clipboard API não disponível. Tente copiar manualmente.");
                        try { // Fallback para document.execCommand para navegadores mais antigos (embora obsoleto)
                            const successful = document.execCommand('copy');
                            if (successful) {
                                this.showNotification("Mensagem rápida copiada (método alternativo)!");
                            } else {
                                this.showNotification("Falha ao copiar. Copie manualmente.", 0);
                            }
                        } catch (errFallback) {
                            console.error("Erro no fallback document.execCommand('copy'):", errFallback);
                            this.showNotification("Falha ao copiar. Copie manualmente.", 0);
                        }
                        return;
                    }
                
                    navigator.clipboard.writeText(text).then(() => {
                        this.showNotification("Mensagem rápida copiada!");
                    }).catch(err => {
                        console.error("Falha ao copiar mensagem rápida via Clipboard API:", err);
                        this.showNotification("Falha ao copiar. Verifique as permissões ou copie manualmente.", 0);
                    });
                },

                generateWhatsAppMessage(isFinalized = false) { 
                    const validItems = this.currentOrder.filter(item => item.brand && item.quantity > 0);
                    if (validItems.length === 0 && !isFinalized) return this.showNotification("Adicione itens.");
                    if (!this.currentClient) return this.showNotification("Selecione um cliente.");
                    const total = parseFloat(document.getElementById('order-total').textContent) || 0;
                    const itemsSummary = validItems.map(item => `${item.quantity}x ${item.brand}`).join(', ');
                    
                    let paymentMethod = "";
                    let paymentMethodText = "";

                    if (isFinalized && this.currentClient.orders && this.currentClient.orders.length > 0) {
                        paymentMethod = this.currentClient.orders[0].paymentMethod || "";
                    } else {
                        paymentMethod = document.getElementById('payment-method').value || "";
                    }

                    paymentMethodText = paymentMethod; // Usa o valor direto salvo/selecionado
                    // A exibição de "Pago Antecipadamente" já está correta se esse for o valor.

                    let message = `Cliente : ${this.currentClient.name}\n`;
                    message += `Endereço: ${this.currentClient.address || 'N/A'}\n`;
                    if (itemsSummary) {
                        message += `Pedido : ${itemsSummary}\nTotal : R$ ${total.toFixed(2)}\n`;
                        if (paymentMethod) message += `Pagamento: ${paymentMethodText}`;
                    } else if (isFinalized) { 
                        message += `Pedido : (Sem itens detalhados)\nTotal : R$ ${total.toFixed(2)}\n`;
                         if (paymentMethod) message += `Pagamento: ${paymentMethodText}`;
                    }

                    const textarea = document.getElementById('whatsapp-message-complete');
                    if (textarea) {
                        textarea.value = message; 
                        textarea.classList.remove('hidden'); 
                        textarea.focus(); 
                        textarea.select();
                        try { 
                            navigator.clipboard.writeText(message).then(() => { 
                                if (!isFinalized) this.showNotification("Mensagem completa copiada!"); 
                            }).catch(err => {
                                console.warn('Falha ao copiar msg completa automaticamente:', err);
                                if (!isFinalized) this.showNotification("Mensagem gerada. Copie manualmente se necessário.", 3000);
                            });
                        } catch (err) { 
                            console.warn('Exceção ao tentar copiar msg completa:', err); 
                            if (!isFinalized) this.showNotification("Mensagem gerada. Copie manualmente.", 3000);
                        }
                    }
                },

                sortInactiveClients(key) {
                    if (this.inactiveSortKey === key) {
                        this.inactiveSortDir = this.inactiveSortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.inactiveSortKey = key;
                        this.inactiveSortDir = (key === 'daysInactive' || key === 'lastOrderDate') ? 'desc' : 'asc';
                    }
                    this.updateInactiveClientsPanel(); 
                },
                
                updateInactiveClientsPanel() { 
                    const listEl = document.getElementById('inactive-clients-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    const today = new Date();
                
                    let clientsWithData = this.clients.map(client => {
                        let daysInactive = Infinity;
                        if (client.lastOrderDate) {
                            const lastDate = new Date(client.lastOrderDate + "T00:00:00");
                            daysInactive = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                        }
                        return { ...client, daysInactive };
                    });
                
                    clientsWithData.sort((a, b) => {
                        let valA, valB;
                        if (this.inactiveSortKey === 'name') {
                            valA = a.name.toLowerCase(); valB = b.name.toLowerCase();
                        } else if (this.inactiveSortKey === 'lastOrderDate') {
                            valA = a.lastOrderDate ? new Date(a.lastOrderDate) : new Date(0);
                            valB = b.lastOrderDate ? new Date(b.lastOrderDate) : new Date(0);
                        } else { 
                            valA = a.daysInactive; valB = b.daysInactive;
                        }
                        if (valA < valB) return this.inactiveSortDir === 'asc' ? -1 : 1;
                        if (valA > valB) return this.inactiveSortDir === 'asc' ? 1 : -1;
                        return 0;
                    });
                
                    document.querySelectorAll('#inativos-tab .sortable-header').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                        if (th.getAttribute('onclick').includes(`'${this.inactiveSortKey}'`)) {
                            th.classList.add(this.inactiveSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                        }
                    });

                    if (clientsWithData.length === 0) {
                        listEl.innerHTML = '<tr><td colspan="7" class="px-4 py-3 text-center text-gray-500">Nenhum cliente.</td></tr>';
                        return;
                    }
                    
                    clientsWithData.forEach(client => {
                        let colorClass = 'status-gray', lastOrderStr = 'Nunca comprou';
                        if (client.lastOrderDate) {
                            lastOrderStr = new Date(client.lastOrderDate + "T00:00:00").toLocaleDateString('pt-BR');
                            if (client.daysInactive <= 20) colorClass = 'status-green';
                            else if (client.daysInactive <= 30) colorClass = 'status-yellow';
                            else colorClass = 'status-red';
                        }
                        const row = listEl.insertRow();
                        row.innerHTML = `
                            <td class="px-4 py-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClass}">&nbsp;</span></td>
                            <td class="px-4 py-3 text-sm text-gray-800 hover:text-sky-600 cursor-pointer" onclick="app.openInactiveClientObservationModal('${client.id}')">${client.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-500"><a href="tel:${client.phone.replace(/\D/g, '')}" class="text-sky-600 hover:text-sky-800">${this.formatPhone(client.phone)}</a></td>
                            <td class="px-4 py-3 text-sm text-gray-500">${lastOrderStr}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${client.daysInactive === Infinity ? 'N/A' : client.daysInactive}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 truncate max-w-xs" title="${client.observacoes_inativo || ''}">${client.observacoes_inativo || ''}</td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="app.openInactiveClientObservationModal('${client.id}')" class="btn btn-primary btn-sm">
                                    Ver/Editar Obs.
                                </button>
                            </td>`;
                    });
                },

                openInactiveClientObservationModal(clientId) {
                    const client = this.clients.find(c => c.id === clientId);
                    if (!client) {
                        this.showNotification("Cliente não encontrado para observação.", 0);
                        return;
                    }
                    document.getElementById('inactive-client-id-obs').value = client.id;
                    document.getElementById('inactive-client-name-obs').textContent = client.name;
                    document.getElementById('inactive-client-address-obs').textContent = client.address || 'N/A';
                    document.getElementById('inactive-client-phone-obs').textContent = this.formatPhone(client.phone);
                    document.getElementById('inactive-client-observation-text').value = client.observacoes_inativo || '';
                    document.getElementById('inactive-client-observation-modal').style.display = 'block';
                },

                async saveInactiveClientObservation() {
                    const clientId = document.getElementById('inactive-client-id-obs').value;
                    const observationText = document.getElementById('inactive-client-observation-text').value.trim();
                    if (!clientId) return this.showNotification("ID do cliente não encontrado.", 0);
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    this.showNotification("Salvando observação...", 0);
                    try {
                        const { error } = await this.db.from('clientes').update({ observacoes_inativo: observationText }).eq('id', clientId);
                        if (error) throw error;
                        const clientIndex = this.clients.findIndex(c => c.id === clientId);
                        if (clientIndex !== -1) this.clients[clientIndex].observacoes_inativo = observationText;
                        this.showNotification("Observação salva!", 3000);
                        this.closeModal('inactive-client-observation-modal');
                        this.updateInactiveClientsPanel(); 
                    } catch (error) {
                        this.showNotification(`Erro ao salvar: ${error.message}`, 0);
                        this.closeModal('notification-modal'); 
                    }
                },
                
                updateLastOrdersSummary() { 
                    const container = document.getElementById('last-orders-list'); if (!container) return;
                    container.innerHTML = '';
                    if (!this.currentClient || !this.currentClient.orders || this.currentClient.orders.length === 0) {
                        container.innerHTML = '<p class="text-gray-500">Nenhum pedido anterior.</p>'; return;
                    }
                    const lastOrders = this.currentClient.orders.slice(0, 5); 
                    lastOrders.forEach(order => {
                        const orderDate = new Date(order.date + "T00:00:00").toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: '2-digit'});
                        const itemsSummary = order.items.map(item => `${item.quantity}x ${item.brand}`).join(', ');
                        let paymentInfo = order.paymentMethod ? ` – ${order.paymentMethod}` : '';
                        // A exibição de "Pago Antecipadamente" já está correta se esse for o valor salvo.
                        
                        const clientDetails = `${this.currentClient.name}, ${this.currentClient.address || 'Endereço não informado'}`;
                        const p = document.createElement('p');
                        p.innerHTML = `${orderDate} – ${itemsSummary} – R$ ${order.total.toFixed(2)}${paymentInfo} – ${clientDetails}`;
                        container.appendChild(p);
                    });
                },

                setDefaultReportMonth() {
                    const reportMonthEl = document.getElementById('report-month');
                    if (reportMonthEl) {
                        const now = new Date();
                        reportMonthEl.value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                    }
                },

                async generateSalesReport() { 
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    const monthYear = document.getElementById('report-month').value;
                    const reportSummaryEl = document.getElementById('sales-report-summary');
                    const exportBtn = document.getElementById('export-excel-button');
                    const detailedReportTbody = document.getElementById('detailed-sales-report-tbody');
                    this.detailedOrdersData = []; 
                    if(detailedReportTbody) detailedReportTbody.innerHTML = '<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">Gerando...</td></tr>';
                    if (!monthYear) {
                        if(reportSummaryEl) reportSummaryEl.innerHTML = '<p>Selecione mês/ano.</p>';
                        if (this.salesChartInstance) this.salesChartInstance.destroy();
                        if(exportBtn) exportBtn.classList.add('hidden');
                        if(detailedReportTbody) detailedReportTbody.innerHTML = '<tr><td colspan="6" class="px-3 py-3 text-center">Selecione o mês.</td></tr>';
                        return;
                    }
                    const [year, month] = monthYear.split('-').map(Number);
                    this.showNotification("Gerando relatório...", 0);
                    try {
                        const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                        const endDate = new Date(year, month, 0).toISOString().split('T')[0]; 
                        const { data: ordersInMonth, error } = await this.db.from('pedidos').select('*, client:clientes(name)')
                            .gte('date', startDate).lte('date', endDate).order('date', { ascending: true });
                        if (error) throw error;
                        this.detailedOrdersData = ordersInMonth; 
                        if(detailedReportTbody) {
                            detailedReportTbody.innerHTML = ''; 
                            if (ordersInMonth.length === 0) detailedReportTbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum pedido.</td></tr>';
                            else {
                                ordersInMonth.forEach(order => {
                                    const clientName = order.client ? order.client.name : 'N/A';
                                    const orderDate = new Date(order.date + "T00:00:00").toLocaleDateString('pt-BR');
                                    order.items.forEach(item => {
                                        const row = detailedReportTbody.insertRow();
                                        row.innerHTML = `<td>${orderDate}</td><td>${clientName}</td><td>${item.brand}</td><td>${item.quantity}</td><td>R$ ${(item.price * item.quantity).toFixed(2)}</td><td>${order.paymentMethod}</td>`;
                                    });
                                });
                            }
                        }
                        const salesByBrand = {}; this.products.forEach(p => salesByBrand[p.name] = { quantity: 0, totalValue: 0 });
                        ordersInMonth.forEach(order => order.items.forEach(item => { if (salesByBrand[item.brand]) { salesByBrand[item.brand].quantity += item.quantity; salesByBrand[item.brand].totalValue += item.quantity * item.price; }}) );
                        const reportDataForChart = Object.entries(salesByBrand).filter(([_, data]) => data.quantity > 0);
                        if (reportDataForChart.length === 0 && ordersInMonth.length === 0) {
                            if(reportSummaryEl) reportSummaryEl.innerHTML = `<p>Nenhuma venda em ${month}/${year}.</p>`;
                            if (this.salesChartInstance) this.salesChartInstance.destroy();
                            if(exportBtn) exportBtn.classList.add('hidden');
                            this.showNotification("Relatório gerado. Nenhuma venda.", 2000); return;
                        }
                        let summaryHTML = `<h3 class="text-lg font-semibold mb-2">Resumo em ${month}/${year}:</h3><ul>`;
                        reportDataForChart.forEach(([brand, data]) => summaryHTML += `<li>${brand}: ${data.quantity} galões (R$ ${data.totalValue.toFixed(2)})</li>`);
                        summaryHTML += '</ul>'; if(reportSummaryEl) reportSummaryEl.innerHTML = summaryHTML;
                        if(exportBtn && (ordersInMonth.length > 0 || reportDataForChart.length > 0) ) exportBtn.classList.remove('hidden');
                        const chartLabels = reportDataForChart.map(([brand, _]) => brand);
                        const chartQuantities = reportDataForChart.map(([_, data]) => data.quantity);
                        const chartValues = reportDataForChart.map(([_, data]) => data.totalValue);
                        const ctx = document.getElementById('sales-chart').getContext('2d');
                        if (this.salesChartInstance) this.salesChartInstance.destroy();
                        this.salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [ { label: 'Galões Vendidos', data: chartQuantities, backgroundColor: 'rgba(54, 162, 235, 0.6)', yAxisID: 'yQuantities' }, { label: 'Valor Total (R$)', data: chartValues, backgroundColor: 'rgba(75, 192, 192, 0.6)', yAxisID: 'yValues' } ]}, options: { responsive: true, maintainAspectRatio: true, scales: { yQuantities: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Galões' } }, yValues: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'R$' }, grid: { drawOnChartArea: false } }}}});
                        this.showNotification("Relatório gerado.", 2000);
                    } catch (error) {
                        this.showNotification(`Erro ao gerar relatório: ${error.message}`);
                        if(reportSummaryEl) reportSummaryEl.innerHTML = '<p class="text-red-500">Erro nos dados.</p>';
                        if(detailedReportTbody) detailedReportTbody.innerHTML = '<tr><td colspan="6" class="text-red-500">Erro nos dados.</td></tr>';
                        this.closeModal('notification-modal');
                    }
                },

                async exportSalesReportToExcel() { 
                    if (!this.db) return this.showNotification("Erro: Conexão não estabelecida.", 0);
                    const monthYear = document.getElementById('report-month').value;
                    if (!monthYear) return this.showNotification("Selecione o mês.");
                    this.showNotification("Exportando Excel...", 0);
                    try {
                        const salesByBrand = {}; this.products.forEach(p => salesByBrand[p.name] = { quantity: 0, totalValue: 0 });
                        if (!this.detailedOrdersData || this.detailedOrdersData.length === 0) {
                            this.showNotification("Nenhum dado para exportar.", 3000); this.closeModal('notification-modal'); return;
                        }
                        this.detailedOrdersData.forEach(order => order.items.forEach(item => { if (salesByBrand[item.brand]) { salesByBrand[item.brand].quantity += item.quantity; salesByBrand[item.brand].totalValue += item.quantity * item.price; }}) );
                        const summaryDataForExport = [["Marca", "Galões Vendidos", "Valor Total (R$)"]];
                        Object.entries(salesByBrand).forEach(([brand, data]) => { if (data.quantity > 0) summaryDataForExport.push([brand, data.quantity, data.totalValue.toFixed(2)]); });
                        const wb = XLSX.utils.book_new();
                        if (summaryDataForExport.length > 1) XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryDataForExport), "Resumo");
                        else XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Nenhum resumo."]]), "Resumo");
                        const detailedDataForExport = [ ["Data do pedido", "Cliente", "Marca", "Quantidade", "Valor (R$)", "Forma de pagamento"] ];
                        this.detailedOrdersData.forEach(order => {
                            const clientName = order.client ? order.client.name : 'N/A';
                            const orderDate = new Date(order.date + "T00:00:00").toLocaleDateString('pt-BR');
                            order.items.forEach(item => detailedDataForExport.push([orderDate, clientName, item.brand, item.quantity, (item.price * item.quantity).toFixed(2), order.paymentMethod]));
                        });
                        if (detailedDataForExport.length > 1) XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detailedDataForExport), "Detalhe");
                        else XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Nenhum detalhe."]]), "Detalhe");
                        const [year, month] = monthYear.split('-').map(Number);
                        XLSX.writeFile(wb, `Relatorio_Vendas_${year}_${String(month).padStart(2,'0')}.xlsx`);
                        this.showNotification("Relatório exportado!");
                    } catch (error) {
                        this.showNotification(`Erro ao exportar: ${error.message}`);
                    } finally { this.closeModal('notification-modal'); }
                },

                openLocatorModal() {
                    document.getElementById('locator-search-term').value = '';
                    document.getElementById('locator-results').innerHTML = '<p>Digite para buscar...</p>';
                    document.getElementById('locator-modal').style.display = 'block';
                    document.getElementById('locator-search-term').focus();
                },

                searchClientsUniversal() { 
                    const searchTerm = document.getElementById('locator-search-term').value.toLowerCase().trim();
                    const resultsContainer = document.getElementById('locator-results'); resultsContainer.innerHTML = '';
                    if (searchTerm.length < 2) { resultsContainer.innerHTML = '<p>Digite ao menos 2 caracteres.</p>'; return; }
                    const foundClients = this.clients.filter(client => client.name.toLowerCase().includes(searchTerm) || (client.address && client.address.toLowerCase().includes(searchTerm)) || client.phone.includes(searchTerm.replace(/\D/g, '')));
                    if (foundClients.length === 0) { resultsContainer.innerHTML = '<p>Nenhum cliente encontrado.</p>'; return; }
                    foundClients.forEach(client => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b hover:bg-sky-100 cursor-pointer rounded';
                        div.innerHTML = `<p class="font-semibold">${client.name}</p><p class="text-sm">${client.address || 'N/A'} - ${this.formatPhone(client.phone)}</p>`;
                        div.onclick = () => { this.displayClientDetails(client); this.closeModal('locator-modal'); };
                        resultsContainer.appendChild(div);
                    });
                },

                displayAllClients() { 
                    const listEl = document.getElementById('all-clients-list'); if(!listEl) return; listEl.innerHTML = ''; 
                    const sortedClients = [...this.clients].sort((a, b) => (new Date(b.createdAt || 0)) - (new Date(a.createdAt || 0)));
                    if (sortedClients.length === 0) { listEl.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum cliente.</td></tr>'; return; }
                    sortedClients.forEach(client => {
                        const row = listEl.insertRow();
                        const createdAtDate = client.createdAt ? new Date(client.createdAt) : null;
                        const formattedDate = createdAtDate ? `${createdAtDate.toLocaleDateString('pt-BR')} ${createdAtDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'})}` : 'N/A';
                        row.innerHTML = `<td>${formattedDate}</td><td>${client.name}</td><td>${client.address || 'N/A'}</td><td>${this.formatPhone(client.phone)}</td>`;
                    });
                }
            }; 
            window.app.init();
        }); 
    </script>
</body>
</html>
